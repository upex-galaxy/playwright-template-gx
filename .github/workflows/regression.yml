#!No modificar Archivo. Este pipeline es para correr todos los tests como Regression.
name: ðŸ§ªPlaywright Regression Testing
run-name: ${{github.actor}}ðŸ‘¨ðŸ»â€ðŸ”¬ ran Regression in ${{github.ref_name}}
on:
  push:
    branches: [QA]

jobs:
  RegressionTesting:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“˜ Checkout Repo
      uses: actions/checkout@v3

    - name: ðŸ’¿ Installing Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: ðŸ§¬ Install YARN and All Dependencies
      run: |
        npm install -g yarn
        yarn
        yarn list

    - name: ðŸŽ­ï¸ Installing Playwright And Browsers
      run: |
        yarn pw:install

    - name: âœ… ðŸ§ªTest Suite Execution
      run: |
        yarn regression

    - name: ðŸ“ŠGenerate Allure Report
      run: |
        yarn allure:open

    - name: ðŸ“¡Upload Artifact - Allure Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-report
        path: allure-report
        retention-days: 15

    - name: âœ…Import Test Results to Xray
      if: always()
      uses: mikepenz/xray-action@v2
      with:
        username: ${{secrets.XRAY_CLIENT_ID}}
        password: ${{secrets.XRAY_CLIENT_SECRET}}
        testFormat: 'junit'
        testPaths: 'playwright-report/importer-report.xml'
        testExecKey: 'GX3-1533' #* Este deberÃ­a ser el TX predeterminado para este Pipeline de RegresiÃ³n.
        projectKey: 'GX3'

  Create-PullRequest:
    needs: [RegressionTesting]
    runs-on: ubuntu-latest
    steps:
    - name: ðŸš©Create Pull Request
      uses: actions/github-script@v6
      with:
        script: |
          const { repo, owner } = context.repo;
          const result = await github.rest.pulls.create({
          title: 'âœ…[QA REGRESSION PASSED]: Ready to Merge into MAIN',
          owner,
          repo,
          head: '${{ github.ref_name }}',
          base: 'main',
          body: [
              'Update branch by Automation Pipeline:',
              '- (CI) Last Story Test Execution PASSEDâœ…',
              '- (CI) Regression Test Execution PASSEDâœ…',
              'ðŸ†—No Conflicts in Repo Source Branch'
          ].join('\n')
          });
          github.rest.issues.addLabels({
          owner,
          repo,
          issue_number: result.data.number,
          labels: ['autoPullRequest']
          });

  AutoMerge-into-Main:
    needs: [Create-PullRequest]
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ§¬Merge QA -> MAIN
      uses: devmasx/merge-branch@master
      with:
        type: now
        label_name: 'autoPullRequest'
        target_branch: 'main' #RAMA PRINCIPAL DEL REPOSITORIO PRESENTE
        github_token: ${{ github.token }}
